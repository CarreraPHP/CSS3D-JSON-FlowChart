<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<title>Flow Chart</title>
		<link rel="stylesheet" href="index.css" />
		<style>
			
		</style>
	</head>
	<body>
		<script src="three.min.js"></script>
		<script src="tween.min.js"></script>
		<script src="TrackballControls.js"></script>
		<script src="CSS3DRenderer.js"></script>

		<div id="container"></div>
		<script>
			var camera, scene, renderer;
			var controls;

			var objects = [];
			var grid = [];

			var i=1, xArr = [0];
			for(; i <= 50; i++){xArr.push(i);xArr.push(-i);}
var chart = [{
    id: 'ch0001',
    name: 'User is getting slow response',
    description: '',
    options: [{
        name: 'Always',
        impact: -1,
        charts: 'ch0001-ch0002'
    }]
}, {
    id: 'ch0001-ch0002',
    name: 'Use APM Introscope to monitor the execution time for queries, heap size, etc',
    description: '',
    options: [{
        name: 'Check',
        impact: -1,
        charts: 'ch0001-ch0002-ch0003'
    }, {
        name: 'Always',
        charts: 'ch0001-ch0002-ch0004'
    }]
}, {
    id: 'ch0001-ch0002-ch0003',
    name: 'Check whether the utilization of the server is high',
    description: '',
    options: [{
        name: 'Always',
        impact: -1,
        charts: 'ch0001-ch0002-ch0003-ch0005'
    }]
}, {
    id: 'ch0001-ch0002-ch0004',
    name: 'Nothing Here',
    description: '',
    options: [{
        name: 'finish',
        charts: ''
    }]
}, {
    id: 'ch0001-ch0002-ch0003-ch0005',
    name: 'Check whether the Query is taking more time',
    description: '',
    options: [{
        name: 'Always',
        impact: -1,
        charts: 'ch0001-ch0002-ch0003-ch0005-ch0006'
    }]
}, {
    id: 'ch0001-ch0002-ch0003-ch0005-ch0006',  
    name: 'Try with different login id\'s and see if for all users getting slow response',
    description: '',
    options: [{
        name: 'Finish',
        charts: ''
    }]
}];

			function createOptHolder(){
				var details = document.createElement( 'div' );
				details.className = 'details';
				return details;
			}

			function createOptSiblings(optHolder, content){
				var options = document.createElement('div');
				options.innerHTML = content;
				optHolder.appendChild(options);
			}

			function createCard(content){
				var element = document.createElement( 'div' );
				element.id = content.id;
				element.className = 'element';
// 				element.style.backgroundColor = 'rgba(0,127,127,' + ( Math.random() * 0.2 + 0.25 ) + ')';
				element.style.backgroundColor = 'rgba(250,250,250,' + ( Math.random() * 0.08 ) + ')';

				var symbol = document.createElement( 'div' );
				symbol.className = 'symbol';
				symbol.textContent = content.name;
				element.appendChild( symbol );

				return element;
			}

			function parseChartOptions(opts){
				var optHolder = createOptHolder();
				for(var z in opts){
// 					console.log("options : ", z, opts[z]);
					var opt = opts[z];
					if(opt.charts.length > 0){
// 						parserChartList(opt.charts);
					}
					createOptSiblings(optHolder, opt.name);
				}
				return optHolder;
			}

			function parserChartList(lists, z_index){
				for(var z in lists){
					var lt = lists[z];
					var ltCard = createCard(lt);
					console.log("chart : ", z, lt, lt.options);
					if(lt.options.length > 0){
						ltCard.appendChild(parseChartOptions(lt.options));
					}

					var object = new THREE.CSS3DObject( ltCard );
					object.position.x = 0; //Math.random() * 4000 - 2000;
					object.position.y = 0; //Math.random() * 4000 - 2000;
					object.position.z = z_index || 0; //Math.random() * 4000 - 2000;
					scene.add( object );

					objects.push( object );
				}
			}

			init();
			
			animate();

			function init() {

				window.camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 30000 );
				camera.position.z = 3000;

				scene = new THREE.Scene();

				parserChartList(chart, 0);

				var nObjects = [], max_cnt = 0;

				for(var y in objects){
					var x = objects[y], x_id = x.element.id, v = x_id.split('-'), u = v.length - 1;

					if(u in nObjects){
						nObjects[u].push(x);
					} else {
						nObjects[u] = [x];
					}
				}

				for(var w in nObjects){
					max_cnt = (nObjects[w].length > max_cnt) ? nObjects[w].length : max_cnt;
				}

				max_y = (max_cnt * 400) / 2;
				console.log(max_cnt, max_y);

				var cnObjects = nObjects, cardStart = true, _x = 0, _y = 0, _z = 0, nObjIndex = 0;

				while(cnObjects.length !== 0){
					var cur = cnObjects.shift();
					
					for(var curIndex in cur){
						if(cur.length == 1 && cardStart){
							_x = 0; _y = 0; _z = 0;
							cur[curIndex].position.x = 0;
							cur[curIndex].position.y = 0;
							cur[curIndex].position.z = 0;
							cardStart = false;
						}else{
							var parentObj = false, 
								parentObjArr = nObjects[nObjIndex],
								elem = cur[curIndex].element,
								elemId = elem.id,
								elemIdArr = elemId.split('-');

							elemIdArr.pop();
							var parenElemId = elemIdArr.join('-')
							for (var _nox in parentObjArr){
								if(parentObjArr[_nox].element.id == parenElemId){
									parentObj = parentObjArr[_nox];
								}
							}
						}
						grid.push(cur[curIndex]);
					}

					nObjIndex++;
				}


/*
				// grid
				for ( var i = objects.length-1, y_level = 0, y_matrix = []; i >= 0; i-- ) {
					var object = new THREE.Object3D(),
						j = objects.length-(i+1),
						sEl = objects[j].element,
						sElId = sEl.id,
						idArr = sElId.split('-');
					
					y_level = idArr.length;	
					(y_level in y_matrix) ? y_matrix[y_level]++ : (y_matrix[y_level] = 0);
				}

				// grid
				for ( var i = objects.length-1, y_level = 0; i >= 0; i-- ) {
					var object = new THREE.Object3D(),
						sEl = objects[j].element,
						sElId = sEl.id,
						idArr = sElId.split('-');

					y_level = idArr.length;
					
					console.log("object POS ", y_level, y_matrix, object.position.x, object.position.y, object.position.z);

					y_matrix[y_level] = y_matrix[y_level] * -1;
					var inr = y_matrix[y_level];
					if(inr != 0){
						j = objects.length-(i+1);
						if()j = j-1;

					}

					object.position.x = (j) * 600;
					object.position.y = (y_level * inr) * 400;
					object.position.z = 0;

					grid.push( object );

					
					
				}
*/
				renderer = new THREE.CSS3DRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.domElement.style.position = 'absolute';
				document.getElementById( 'container' ).appendChild( renderer.domElement );

				controls = new THREE.TrackballControls( camera, renderer.domElement );
				controls.rotateSpeed = 0.5;
				controls.minDistance = 0;
				controls.maxDistance = 10000;
				controls.addEventListener( 'change', render );

				transform(grid, 2000 );

				window.addEventListener( 'resize', onWindowResize, false );

			}

			function transform( targets, duration ) {

				TWEEN.removeAll();

				for ( var i = 0; i < objects.length; i ++ ) {

					var object = objects[ i ];
					var target = targets[ i ];

					new TWEEN.Tween( object.position )
						.to( { x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration )
						.easing( TWEEN.Easing.Exponential.InOut )
						.start();

					new TWEEN.Tween( object.rotation )
						.to( { x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random() * duration + duration )
						.easing( TWEEN.Easing.Exponential.InOut )
						.start();

				}

				new TWEEN.Tween( this )
					.to( {}, duration * 2 )
					.onUpdate( render )
					.start();

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				render();

			}

			function animate() {

				requestAnimationFrame( animate );

				TWEEN.update();

				controls.update();

			}

			function render() {

				renderer.render( scene, camera );

			}

		</script>
	</body>
</html>
